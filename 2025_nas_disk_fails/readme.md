---
title: NAS Disk failure
subtitle: remplacer le disque qui a des erreurs
author: qkzk
date: 2025-07-19
theme: metropolis
geometry: "margin=1.5cm"

---

## Historique 

Depuis 3 mois j'ai 5 erreurs rapportées par smartctrl
Le total est monté à 7 depuis hier.

## Plan 

1. Remplacer le disque mort 
2. Si ça marche, les remplacer tous 

## Etape 1 : remplacer le disque HS.

### Problème

This message was generated by the smartd daemon running on:

   host name:  qnas
   DNS domain: [Empty]

The following warning/error was logged by the smartd daemon:

Device: /dev/sdf [SAT], 7 Offline uncorrectable sectors

Device info:
WDC WD30EFRX-68EUZN0, S/N:WD-WCC4N3LHTSCZ, WWN:5-0014ee-2b87b6f7c, FW:82.00A82, 3.00 TB

For details see host's SYSLOG.

You can also use the smartctl utility for further investigation.
The original message about this issue was sent at Wed Feb 26 11:26:33 2025 CET

### Quel est le disque en question ? impossible de dire sans démonter

Les autocollants disent "abcd" donc /dev/sda etc. mais mdadm dit :

       0       8       80        0      active sync   /dev/sdf
       1       8       16        1      active sync   /dev/sdb
       4       8       32        2      active sync   /dev/sdc
       3       8       64        3      active sync   /dev/sde

### Achat d'un disque de remplacement 

Seagate ironwolf 6To sur amazon: 165.99€ [facture](./facture_seagate_ironwolf_6To.pdf)

### Etapes 

- [x] Ecran, clavier
- [ ] retirer du raid 
- [ ] Démonter identifier
- [ ] Remplacer le bon 
- [ ] réassembler le raid

ports de gauche à droite

- 1. port 1: WD30EFRX-68EUZN0 WCC4N3LHTSCZ -> /dev/sdf : **A REMPLACER**
- 2. port 2: WD30EFRX-68EUZN0 WCC4N3LHT3D8 -> /dev/sdb
- 3. port 3: WD30EFRX-68EUZN0 WCC4N4SU73S1 -> /dev/sdc
- 4. port 4: WD30EFRX-68EUZN0 WCC4N0FVSTDL -> /dev/sde

### Retirer du raid 

1. marquer comme defecteux
2. retirer du raid 

```sh 
sudo mdadm --manage --fail /dev/md127 /dev/sdf 

sudo mdadm --manage --remove /dev/md127 /dev/sdf
```

3. Ajouter nouveau disque 

installer: ajouté une etiquette avec son numéro de série, 


nouveau disque : seagate 6T 

port 1: ST6000VN006 - ZVX063KJ - 2ZM18 - 500 -> /dev/sdf

formater

```sh 
$ sudo parted -a optimal /dev/sdf
GNU Parted 3.2
Using /dev/sdf
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) mklabel gpt
(parted) mkpart primary 1 -1
(parted) set 1 raid on
(parted) print
Model: ATA ST6000VN006-2ZM1 (scsi)
Disk /dev/sdf: 6001GB
Sector size (logical/physical): 512B/4096B
Partition Table: gpt
Disk Flags:

Number  Start   End     Size    File system  Name     Flags
 1      1049kB  6001GB  6001GB               primary  raid

(parted) quit
Information: You may need to update /etc/fstab.
```


vérif :

```sh 
sudo smartctl -a /dev/sdf
smartctl 6.6 2017-11-05 r4594 [x86_64-linux-4.19.0-27-amd64] (local build)
Copyright (C) 2002-17, Bruce Allen, Christian Franke, www.smartmontools.org

=== START OF INFORMATION SECTION ===
Device Model:     ST6000VN006-2ZM186
Serial Number:    ZVX063KJ
LU WWN Device Id: 5 000c50 0ea4b48f0
Firmware Version: SC60
User Capacity:    6,001,175,126,016 bytes [6.00 TB]
Sector Sizes:     512 bytes logical, 4096 bytes physical
Rotation Rate:    5400 rpm
Form Factor:      3.5 inches
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-3 T13/2161-D revision 5
SATA Version is:  SATA 3.1, 6.0 Gb/s (current: 3.0 Gb/s)
Local Time is:    Sat Jul 19 16:10:57 2025 CEST
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

=== START OF READ SMART DATA SECTION ===
SMART overall-health self-assessment test result: PASSED

General SMART Values:
Offline data collection status:  (0x00)	Offline data collection activity
					was never started.
					Auto Offline Data Collection: Disabled.
Self-test execution status:      (   0)	The previous self-test routine completed
					without error or no self-test has ever
					been run.
Total time to complete Offline
data collection: 		(    0) seconds.
Offline data collection
capabilities: 			 (0x73) SMART execute Offline immediate.
					Auto Offline data collection on/off support.
					Suspend Offline collection upon new
					command.
					No Offline surface scan supported.
					Self-test supported.
					Conveyance Self-test supported.
					Selective Self-test supported.
SMART capabilities:            (0x0003)	Saves SMART data before entering
					power-saving mode.
					Supports SMART auto save timer.
Error logging capability:        (0x01)	Error logging supported.
					General Purpose Logging supported.
Short self-test routine
recommended polling time: 	 (   1) minutes.
Extended self-test routine
recommended polling time: 	 ( 660) minutes.
Conveyance self-test routine
recommended polling time: 	 (   2) minutes.
SCT capabilities: 	       (0x70bd)	SCT Status supported.
					SCT Error Recovery Control supported.
					SCT Feature Control supported.
					SCT Data Table supported.

SMART Attributes Data Structure revision number: 10
Vendor Specific SMART Attributes with Thresholds:
ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
  1 Raw_Read_Error_Rate     0x000f   100   100   006    Pre-fail  Always       -       20000
  3 Spin_Up_Time            0x0003   098   098   000    Pre-fail  Always       -       0
  4 Start_Stop_Count        0x0032   100   100   020    Old_age   Always       -       2
  5 Reallocated_Sector_Ct   0x0033   100   100   010    Pre-fail  Always       -       0
  7 Seek_Error_Rate         0x000f   100   253   045    Pre-fail  Always       -       422
  9 Power_On_Hours          0x0032   100   100   000    Old_age   Always       -       0
 10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always       -       0
 12 Power_Cycle_Count       0x0032   100   100   020    Old_age   Always       -       2
183 Runtime_Bad_Block       0x0032   100   100   000    Old_age   Always       -       0
184 End-to-End_Error        0x0032   100   100   099    Old_age   Always       -       0
187 Reported_Uncorrect      0x0032   100   100   000    Old_age   Always       -       0
188 Command_Timeout         0x0032   100   253   000    Old_age   Always       -       0
189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always       -       0
190 Airflow_Temperature_Cel 0x0022   063   063   040    Old_age   Always       -       37 (Min/Max 31/37)
191 G-Sense_Error_Rate      0x0032   100   100   000    Old_age   Always       -       0
192 Power-Off_Retract_Count 0x0032   100   100   000    Old_age   Always       -       2
193 Load_Cycle_Count        0x0032   100   100   000    Old_age   Always       -       3
194 Temperature_Celsius     0x0022   037   040   000    Old_age   Always       -       37 (0 31 0 0 0)
195 Hardware_ECC_Recovered  0x001a   100   100   000    Old_age   Always       -       20000
197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       0
198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       0
199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0
240 Head_Flying_Hours       0x0000   100   253   000    Old_age   Offline      -       0 (67 152 0)
241 Total_LBAs_Written      0x0000   100   253   000    Old_age   Offline      -       288
242 Total_LBAs_Read         0x0000   100   253   000    Old_age   Offline      -       19712

SMART Error Log Version: 1
No Errors Logged

SMART Self-test log structure revision number 1
No self-tests have been logged.  [To run self-tests, use: smartctl -t]

SMART Selective self-test log data structure revision number 1
 SPAN  MIN_LBA  MAX_LBA  CURRENT_TEST_STATUS
    1        0        0  Not_testing
    2        0        0  Not_testing
    3        0        0  Not_testing
    4        0        0  Not_testing
    5        0        0  Not_testing
Selective self-test flags (0x0):
  After scanning selected spans, do NOT read-scan remainder of disk.
If Selective self-test is pending on power-up, resume after 0 minute delay.
```

```sh 
$ sudo lsblk /dev/sdf
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sdf      8:80   0  5.5T  0 disk
└─sdf1   8:81   0  5.5T  0 part
```

ajouter au raid 

```sh 
sudo mdadm --manage --add /dev/md127 /dev/sdf1
```

consulter l'avancer avec 

```sh 
$ cat /proc/mdstat
```

surveiller avec 

```sh 
$ watch -t 'cat /proc/mdstat'
```

```sh 
Personalities : [raid6] [raid5] [raid4] [linear] [multipath] [raid0] [raid1] [raid10]
md127 : active raid5 sdf1[5] sdb[1] sde[3] sdc[4]
      8790405120 blocks super 1.2 level 5, 512k chunk, algorithm 2 [4/3] [_UUU]
      [>....................]  recovery =  0.1% (5279192/2930135040) finish=1068.9min speed=45604K/sec
      bitmap: 4/22 pages [16KB], 65536KB chunk

unused devices: <none>
```

1000 mins = 19h

devrait être fini vers 11h dimanche

## Améliorer le raid 

Une fois l'ajout terminé,

1. commander trois autres disques,
2. retirer et ajouter un par un.
3. étendre le raid

Devrait prendre 3x1000m = 3000m = 54h = ~3 jours



